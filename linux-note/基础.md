# Linux基础

## 简介

* `Linux`英文解释为`Linux is not Unix`
* 由Linus Torvalds在赫尔辛基大学上学时出于个人爱好而编写
* 免费, 自由传播的类Unix操作系统, 基于POSIX和UNIX的多用户, 多任务, 支持多线程和多CPU
* 发行版: 将Linux内核与应用软件打包发布

## Linux系统启动过程

* 5个阶段
    - 内核引导
        - 打开电源后, 首先BIOS开机自检, 按照BIOS中设置的启动设备(通常是硬盘)来启动
        - 操作系统接管硬件以后, 首先读入`/boot`目录下的内核文件
    - 运行init
        - init进程是系统所有进程的起点, 没有这个进程, 其他任何进程都不会启动
        - init程序首先需要读取配置文件, 如下:
            - `SysV`: CentOS 5之前, 配置文件为`/etc/inittab`
            - `Upstart`: CentOS 6, 配置文件为`/etc/inittab`, `/etc/init/*.conf`
            - `Systemd`: CentOS 7, 配置文件为`/usr/lib/systemd/system`, `/etc/systemd/system`
        - 运行级别   
        Linux允许为不同的场合, 分配不同的开机启动程序, 称为`运行级别`(runlevel). 根据运行级别确定要运行那些程序
            - 7个运行级别:
                - `0`: 系统停机状态, 系统默认运行级别不能设为0, 否则不能正常启动
                - `1`: 单用户工作状态, root权限, 用于系统维护, 禁止远程登录
                - `2`: 多用户状态(没有NFS)
                - `3`: 完全的多用户状态(有NFS), 登录后进入控制台命令行模式
                - `4`: 系统未使用, 保留
                - `5`: X11控制台, 登录后进入GUI图形界面
                - `6`: 系统正常关闭并重启, 默认运行级别不能设为6, 否则不能正常工作
    - 系统初始化   
        - init配置文件中: `si::sysinit:/etc/rc.d/rc.sysinit`, 它执行`/etc/rc.d/rc.sysinit`, 进行激活交换分区, 检查磁盘, 加载硬件模块以及其他一些需要优先执行的任务. 执行`l5:5:wait:/etc/rc.d/rc 5`, 5作为参数, 执行`/etc/rc.d/rc5.d/`目录下的所有rc启动脚本, 该脚本都是连接文件, 启动`/etc/rc.d/init.d/`目录下
        - rc脚本一般能接受`start`, `stop`, `restart`, `status`等参数, 脚本以S开头的启动脚本, 将以`start`参数来运行, 以K开头的启动脚本, 以`stop`为参数停止进程, 然后在重新启动. 这样做的目的是保证党init改变运行级别时, 所有相关守护进程都将重启
        - `chkconfig`: 设定每个级别运行的守护进程(`daemon`)
    - 建立终端
        - 默认打开6个终端, 以便用户登录系统
        - 显示文本登录界面, 验证用户身份
    - 用户登录系统
        - 3种登录方式:
            - 命令行登录
            - ssh登录
            - 图形界面登录
        - 预设6个命令行窗口终端机用于登录
            - 默认登录的是第一个窗口, 也就是`tty1`
            - `Ctrl + Alt + F1 ~ F6`切换命令行界面
            - `Ctrl + Alt + F7`恢复图形界面
    - 关机    
    Linux大多用于服务器, 很少关机
        - 正确的关机流程为: `sync > shutdown > reboot > halt`
            - `sync`: 将数据由内存同步到硬盘中
            - `shutdown`: 关机
            - `reboot`: 重启
            - `halt`: 关闭系统
 
```shell
sync 将数据由内存同步到硬盘中。

shutdown 关机指令，你可以man shutdown 来看一下帮助文档。例如你可以运行如下命令关机：

shutdown –h 10 ‘This server will shutdown after 10 mins’ 这个命令告诉大家，计算机将在10分钟后关机，并且会显示在登陆用户的当前屏幕中。

Shutdown –h now 立马关机

Shutdown –h 20:25 系统会在今天20:25关机

Shutdown –h +10 十分钟后关机

Shutdown –r now 系统立马重启

Shutdown –r +10 系统十分钟后重启

reboot 就是重启，等同于 shutdown –r now

halt 关闭系统，等同于shutdown –h now 和 poweroff
```

## 系统目录结构

```shell
/                # 系统根目录
|_ bin/          # 二进制文件, 常用的命令都在这里
|_ boot/         # 启动Linux时的核心文件, 包括一些连接文件和镜像文件
|_ dev/          # 外部设备, Linux中访问设备和访问文件的方式是相同的
|_ etc/          # 系统管理所需要的配置文件和子目录
|_ home/         # 用户主目录, 每个用户都有自己的目录, 一般以用户名命名
|_ lib/          # 系统最基本的动态连接共享库
|_ lost+found/   # 一般情况下是空的, 当系统非法关机后会存放一些文件
|_ media/        # 自动识别的设备, 如U盘, 光驱, 识别后会把设备挂载到这个目录下
|_ mnt/          # 用于让用户临时挂载别的文件系统, 可以将光驱, sd卡等挂载在这里
|_ opt/          # 给主机额外安装软件的目录, 默认是空的
|_ proc/         # 虚拟目录, 是系统内存的映射, 用于获取系统信息, 该目录的内容不在硬盘而在内存中
|_ root/         # 超级管理员目录
|_ sbin/         # s是Super User的意思, 超级管理员使用的系统管理程序
|_ selinux/      # 是Redhat/CentOS特有目录, Selinux是一个安全机制, 类似于防火墙
|_ srv/          # 服务启动之后需要提取的数据
|_ sys/          # 2.6内核新出现的文件系统sysfs, 是内核设备树的直观反映
|_ tmp/          # 临时文件
|_ usr/          # 用户的很多应用程序和文件
    |_ bin/      # 系统用户使用的应用程序
    |_ sbin/     # 超级管理员使用的比较高级的管理程序和系统守护程序
    |_ src/      # 内核源代码默认的目录
|_ var/          # 存放不断扩充的东西, 一般习惯将经常被修改的目录放在这里, 如各种日志文件
```

## 忘记密码的解决方法

* 忘记root密码: 进入单用户模式修改root密码即可
    - 重启系统
    - 3秒内按任意键进入启动菜单
    - 按`e`编辑命令
    - 修改`... root=LABEL=/`为`... root=LABEL=/ single` (按e进入编辑模式)
    - 按`b`启动, 进入单用户模式
    - 在单用户模式输入`passwd`重设密码


## 远程登录

* Linux通过ssh服务实现远程登录, 默认ssh服务端口号为22
* `SSH`是`Secure Shell`的缩写
* 登录命令: `ssh <username>@<host>`


## 用户和用户组

Linux系统是多用户多任务的分时操作系统, 任何要使用系统资源的用户, 必须先向系统管理员申请一个账号, 然后以这个账号身份进入系统
用户的账号一方面可以帮助系统管理员对使用系统的用户进行跟踪, 控制他们对系统资源的访问, 另一方面可以帮助用户阻止文件, 为用户提供安全性保护

* 每个用户账号都拥有一个唯一的用户名和各自的口令
* 用户管理
    * 添加用户: `useradd -g group -G adm,root tom`
        - `useradd 选项 用户名`
            - 选项:
                - `-c`: 指定一段注释性描述
                - `-d`: 指定用户主目录. 如果该目录不存在, 同时使用`-m`选项可以创建主目录
                - `-g`: 指定用户组
                - `-G`: 指定附加组
                - `-s`: shell文件, 指定用户登录的shell
                - `-u`: 用户号, 如果同时由`-o`选项, 则可以重复使用其他用户的标识号
    * 删除用户: `userdel tom`
        - `userdel 选项 用户名`
            - 选项:
                - `-r`: 同时删除用户的主目录
    * 修改用户: `usermod -s /bin/ksh -d /home/z -g developer sam`
        - `usermod 选项 用户名`
            - 选项:
                - `-c`: 指定一段注释性描述
                - `-d`: 指定用户主目录. 如果该目录不存在, 同时使用`-m`选项可以创建主目录
                - `-g`: 指定用户组
                - `-G`: 指定附加组
                - `-s`: shell文件, 指定用户登录的shell
                - `-u`: 用户号, 如果同时由`-o`选项, 则可以重复使用其他用户的标识号
                - `-| 新用户名`: 修改用户名
* 用户口令管理: `passwd sam` 
用户刚创建时没有口令, 此时是被系统锁定无法使用的, 必须指定口令(空口令也需要指定)
    - `passwd 选项 用户名`
        - 选项:
            - 无选项: 设置口令
            - `-l`: 锁定口令, 即禁用用户
            - `-u`: 解锁口令
            - `-d`: 清空用户口令 
            - `-f`: 强制用户下次登录时修改口令
        - 如果没有指定用户名, 则默认对当前用户使用命令
* 用户组管理   
用户组的修改实际上是对`/etc/group`文件的更新
    - 新增用户组: `groupadd devgroup`
        - `groupadd 选项 用户组`
            - 选项:
                - `-g GID`: 指定新用户组的组标识号
                - `-o`: 一般与-g选项同时使用, 表示新用户组的GID可以与系统已有用户组的GID相同
    - 删除用户组: `groupdel devgroup`
        - `groupdel 用户组`
    - 修改用户组: `groupmod -n newgroup oldgroup`
        - `groupmod 选项 用户组`
            - 选项:
                - `-g GID`: 为用户组指定新的组标识号
                - `-n 新用户组`: 将原用户组改为新用户组
    - 切换用户组: `newgrp root`
        - 当一个用户同时属于多个用户组, 那么用户可以在用户组之间切换
        - `newgrp 用户组`
* 与用户账号有关的系统文件
    - `/etc/passwd`: 用户基本属性
        - 信息格式: `用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell`
    - `/etc/shadow`: 加密保存用户密码
    - `/etc/group`: 用户组信息
    

## 文件基本属性

* 使用`ll`或`ls -l`列出目录和文件, 并查看文件属性, 所属用户和组
* 文件属性格式: `文件类型|属主权限|属组权限|其他用户权限`
    - 文件类型:
        - `d`: 目录
        - `-`: 文件
        - `l`: 链接文件
        - `b`: 设备文件里可供储存的接口设备(可随机存取设备)
        - `c`: 串行端口设备, 如键盘, 鼠标(一次性读取设备)
    - 权限: 3个一组, `rwx`, 顺序固定
        - `r`: 可读
        - `w`: 可写
        - `x`: 可执行
        - `-`: 没有该类型权限
    - 属主: 文件的所有者, 该用户对文件具有所有权
    - 属组: 用户所在用户组
        - 一个用户可以属于一个或一个以上的用户组
            - 文件所有者
            - 文件所有者同组用户
            - 其他用户
    - 对于root用户, 文件权限一般不起作用
* 修改文件属性
    - `chown`: 修改属主
        - 也可同时修改属组, 格式: `chown 属主:属组 文件`
    - `chgrp`: 修改属组
    - `chmod`: 修改属主, 属组, 其他用户的文件权限
        - 2种设置方法:
            - 数字: 
                - `r`=4
                - `w`=2
                - `x`=1
                - 示例: `chmod 750 file` -> `-rwxr-x---`
            - 符号: 
                - 身份:
                    - `u`: 属主
                    - `g`: 属组
                    - `o`: 其他
                    - `a`: 所有身份
                - 操作:
                    - `+`: 增加
                    - `-`: 去除
                    - `=`: 设置
                - 权限:
                    - `r`: 读
                    - `w`: 写
                    - `x`: 执行
                - 示例: `chmod a+x`


## 文件与目录操作

* `ls [选项]`: 列出文件和目录
    - `-a`: 全部文件, 包括隐藏文件
    - `-d`: 仅列出目录
    - `-l`: 长数据串方式列出, 包括文件属性和权限等信息
* `cd 相对路径或绝对路径`: 切换目录
* `pwd`: 显示当前所在目录
* `mkdir [选项] 目录名称`: 创建目录
    - `-m`: 配置文件权限
    - `-p`: 同时将所需但不存在的目录一同创建
* `rmdir [选项] 目录`: 删除空的目录
    - `-p`: 连同上级空目录一起删除
* `cp [选项] 源文件 目标文件`: 复制文件
    - `-a`: 相当于-pdr
    - `-d`: 如果源文件为连接文件, 则赋值连接文件属性而非文件本身
    - `-f`: 强制, 如果目标文件已经存在且无法打开, 则移除后在尝试一次
    - `-i`: 如果目标文件已经存在, 在覆盖时会先询问
    - `-L`: 使用硬连接创建, 而非复制文件本身
    - `-p`: 连同文件属性一起复制, 而非使用默认属性
    - `-r`: 递归赋值
    - `-s`: 赋值为符号连接文件
    - `-u`: 如果目标文件比源文件旧才复制
* `rm [选项] 文件或目录`: 删除文件或目录
    - `-f`: 强制
    - `-i`: 删除前询问
    - `-r`: 递归删除
* `mv [选项] 源文件或目录 目标文件或目录`: 移动文件或目录; 或修改名称
    - `-f`: 强制
    - `-i`: 移动或重命名前询问
    - `-u`: 当目标文件比源文件新才修改
* `cat [选项] 文件`: 从第一行开始显示文件内容
    - `-A`: 相当于`-vET`
    - `-b`: 列出行号, 空白行不标号
    - `-E`: 将结尾的断行字节`$`显示出来
    - `-n`: 列出行号, 空白行也显示行号
    - `-T`: 将`tab`键以`^|`显示
    - `-v`: 列出看不出的特殊字符
* `tac [选项] 文件`: 从最后一行倒序显示文件内容
    - 选项与cat相同
* `nl [选项] 文件`: 显示行号
    - `-b 样式`: 指定行号样式:
        - `a`: 无论是否空行, 都显示行号
        - `t`: 空行不显示行号
    - `-n 样式`: 指定行号显示的位置
        - `ln`: 屏幕左边
        - `rn`: 屏幕右边, 且不加0
        - `rz`: 屏幕右边, 加0
* `more`: 向下翻动
* `less`: 向上翻动
* `head [选项] 文件`: 显示文件前几行
    - `-n 数字`: 指定显示行数
* `tail [选项] 文件`: 显示文件后几行 
    - `-n 数字`: 指定显示行数
    - `-f`: 持续监测后面的文档名

## 磁盘管理

* `df [选项] [目录或文件名]`: 列出文件系统的整体磁盘使用量
    - 选项
        - `-a`: 列出所有文件系统, 包括`/proc`等文件系统
        - `-k`: 以KByte的容量显示各文件系统
        - `-m`: 以MByte的容量显示各文件系统
        - `-h`: 以易于阅读的GByte, MByte, KByte格式自行显示
        - `-H`: 以M=1000K取代M=1024K进位方式
        - `-T`: 显示文件系统类型, 连同该partition的filesystem名称也列出
        - `-i`: 不适用硬盘容量, 而以inode的数量来显示
* `du [选项] 文件或目录`: 检查磁盘空间使用量
    - 选项
        - `-a`: 列出所有文件与目录容量, 默认仅统计目录底下的文件量
        - `-h`: 以易于阅读的容量格式显示
        - `-s`: 列出总量, 而不列出每个个别目录占用容量
        - `-S`: 不包括子目录下的总计
        - `-k`: 以KB列出容量
        - `-m`: 以MB列出容量
* `fdisk [-l] 设备名称`: 磁盘分区
    - 选项
        - 无选项: 提示命令后执行操作
        - `-l`: 输出设备的所有分区内容
* `mount [-t 文件系统] [-L Label名] [-o 额外选项] [-n]  设备文件名  挂载点`: 挂载磁盘
* `umount 选项 装置文件名或挂载点`: 卸载磁盘
    - 选项:
        - `-f`: 强制
        - `-n`: 不升级`/etc/mtab`情况下卸载
